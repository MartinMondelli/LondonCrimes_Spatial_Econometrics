---
title: "TP Spatial Econometrics"
format: html
editor: visual
---

# TP

#Importing data and packages

```{r}
# install les packages necessaires si ils ne sont pas deja installes
if (!require(sf))      install.packages("sf")
if (!require(mapview))      install.packages("mapview")

# charge les packages
library("sf")
library("mapview")



# chemin adaptatif vers les données 
path_data = paste(getwd(), "2025-07-metropolitan-outcomes.csv", sep = "/")

police = read.csv(path_data)

```

Counting number of NAs

```{r}
sum(is.na(police$Longitude))
sum(is.na(police$Latitude))
```

Filtering

```{r}
police_clean <- police[!is.na(police$Longitude) & !is.na(police$Latitude),]
rm(police, path_data)
gc()
```

Making it sf

```{r}
my_coords <- st_as_sf(police_clean, coords = c("Longitude", "Latitude"), crs = 4326)
```

Plot it

```{r}
mapview(my_coords)
```

# Data base presentation

# I/ Spatial Point Patterns Introduction

# II/ Complete Spatial Randomness

# III/ The k-function

# IV/ Intensity estimation

<<<<<<< HEAD


```{r}

my_coords2 <- st_as_sf(police_clean, coords = c("Longitude", "Latitude"), crs = 4326)


my_coords2 = st_transform(my_coords2, crs = 27700)
# Coordonnées
coords2 <- st_coordinates(my_coords2)



map <- ne_countries(type = "countries", country = "United Kingdom",
                    scale = "small", returnclass = "sf")


map <- st_transform(map, crs = "EPSG:27700")
win <- as.owin(map)


pp <- ppp(
  x = coords2[,1],
  y = coords2[,2],
  window = win
)




# Plot
plot(win, col = "lightgrey")
plot(pp, add = TRUE, pch = 20, col = "red",size = 0.8)




```


```{r}

lambdahat <- density(pp)
attr(lambdahat, "sigma")
```

```{r}
plot(lambdahat, main = "Default bandwidth")
plot(density(X, sigma = 1))
plot(density(X, sigma = 10))
plot(density(X, sigma = 100))
plot(density(X, sigma = 1000))
plot(density(X, sigma = 10000))
```




```{r}
table_var = list()
for (i in colnames(police_clean)) {
  table_var[[i]] = table(police_clean[i])
}
```

```{r}

table_var$Outcome.type

```

We want to test whether points are distributed uniformly on A or not.

```{r}
X <- as.ppp(st_coordinates(my_coords), st_bbox(my_coords)) #Turn sf into ppp
```

```{r}


Q <- quadratcount(X, nx = 100, ny = 120) #Transform ppp into a nx*ny grid. As England is elongated, we use an elongated grid

quadrat.test(Q) #p-value < 0.001 ==> there is a pattern of distribution
quadrat.test(Q, alternative = "regular") #p-value = 1 ==> cannot conclude on a regular pattern
quadrat.test(Q, alternative = "clustered") #p-value < 0.001 ==> clustered points around London

```

```{r}
Q <- quadratcount(X, nx = 2, ny = 2) #Transform ppp into a nx*ny grid. As England is elongated, we use an elongated grid

quadrat.test(Q) #p-value < 0.001 ==> there is a pattern of distribution
quadrat.test(Q, alternative = "regular") #p-value = 1 ==> cannot conclude on a regular pattern
quadrat.test(Q, alternative = "clustered") #p-value < 0.001 ==> clustered points around London
```

```{r}
Q <- quadratcount(X, nx = 1000, ny = 1000) #Transform ppp into a nx*ny grid. As England is elongated, we use an elongated grid

quadrat.test(Q) #p-value < 0.001 ==> there is a pattern of distribution
quadrat.test(Q, alternative = "regular") #p-value = 1 ==> cannot conclude on a regular pattern
quadrat.test(Q, alternative = "clustered") #p-value < 0.001 ==> clustered points around London
```

No matter the grid, it seems that London has too much points clustered

Let's restrict our scope to greater London:

```{r}
library(spatstat.geom)

# Définition d'une bbox autour de Londres (WGS84)
london_bbox <- st_bbox(c(
  xmin = -0.6,
  xmax =  0.3,
  ymin = 51.3,
  ymax = 51.7
), crs = st_crs(4326))

# Transformation en sfc
london_window <- st_as_sfc(london_bbox)

# Restriction aux points dans la bbox
my_coords_london <- my_coords[london_window, ]

# Conversion en ppp
X <- as.ppp(
  st_coordinates(my_coords_london),
  W = as.owin(london_bbox)
)

X
```

```{r}
Q <- quadratcount(X, nx = 10, ny = 10) #Transform ppp into a nx*ny grid. As England is elongated, we use an elongated grid

quadrat.test(Q) #p-value < 0.001 ==> there is a pattern of distribution
quadrat.test(Q, alternative = "regular") #p-value = 1 ==> cannot conclude on a regular pattern
quadrat.test(Q, alternative = "clustered") #p-value < 0.001 ==> clustered points around London
```

```{r}

my_coords <- st_transform(my_coords, 27700)

london_bbox <- st_bbox(c(
  xmin = 528000,
  xmax = 552000,
  ymin = 170000,
  ymax = 200000
), crs = st_crs(27700))

london_window <- st_as_sfc(london_bbox)

my_coords_london <- my_coords[london_window, ]

W <- as.owin(london_bbox)

X <- as.ppp(
  X = st_coordinates(my_coords_london),
  W = W
)


plot(W)
plot(X, add = TRUE, pch = 20)
```
```{r}
Q <- quadratcount(X, nx = 100, ny = 100) #Transform ppp into a nx*ny grid. As England is elongated, we use an elongated grid

quadrat.test(Q) #p-value < 0.001 ==> there is a pattern of distribution
quadrat.test(Q, alternative = "regular") #p-value = 1 ==> cannot conclude on a regular pattern
quadrat.test(Q, alternative = "clustered")
```


=======
>>>>>>> f753981706e8d2aacf63861165a47c2c2026d309
# Conclusion
